#!/bin/bash

# get SHA of submodule head so it can be diffed
dst=~/projects/moose/libmesh
cd $dst
sha=$(git rev-parse HEAD)

# if the submodule is totally clean, then presumably all git diffed files should be copied
copyall=false # assume theres no need to copy all files, only newer ones
reconf=false # assume theres no need to reconfigure
if [ -z "$(git diff)" ]; then 
	copyall=true
	reconf=true
fi

# copy diffed files from libmesh fork to MOOSE submodule
src=~/projects/libmesh
cd $src
for file in $(git diff --name-only $sha)
do
	path=$dst/$(dirname $file)
	if [ ! -d $path ]; then
		mkdir -p $path
	fi

	# only copy the file if its new, in case it's already been diffed and copied
	dstfile=$path/$(basename $file)
	if $copyall || [ $file -nt $dstfile ]; then
		cp -p $file $dstfile
		echo "Copied: $src/$file -> $dstfile"

		# if the default configure file has changed, we ought to reconfigure the MOOSE install as well
		if [ $file = configure ]; then
			reconf=true
		fi
	fi
done

# now rebuild and install libmesh
cd $(dirname $dst)
if [ ! -d $dst/build ] || $reconf; then
	# run the MOOSE libmesh installer
  JOBS=4 ./scripts/update_and_rebuild_libmesh.sh --skip-submodule-update
else
	# reinstall without reconfiguring
  JOBS=4 ./scripts/update_and_rebuild_libmesh.sh --fast --skip-submodule-update
fi
